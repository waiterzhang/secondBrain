## 概念

**1.什么是es？**
分布式开源搜索引擎，可以在海量数据中快速找到内容；es是elk中的核心：

​![image](image-20240217170637-7etisch.png)​

其基于lucene发展而来，这是一种基于倒排索引的算法。

[[Xoo]]
**2.倒排索引**

正排索引通常是指由id指向数据元组，这样的好处在于可以使用索引。但是如果遇见模糊搜索，通常需要全表扫描：

```java
select * from table where col like '%abc';
```

如果遇到海量数据，且需要进行模糊搜索、部分搜索的时候会遇见很大的问题。因为没法走索引了。

倒排索引可以解决这样一种问题。倒排索引首先对**文档**进行分词，然后将分词过后的**词条**当作key，该词条对应的文档当作value进行存储。如图所示：

​​![image](image-20240217171339-1yj5xd7.png)​

在搜索的时候会首先对搜索关键词进行分词，然后走索引找到对应的词条，找到词条后即可找到对应的文档id；

可见，倒排索引主要是通过分词，然后value向key映射，这样解决了不能走索引的问题。

**3.es与mysql概念的对比**

​![image](image-20240217171540-4jfx5ql.png)​

特点对比：

* mysql：擅长事务、安全、一致；
* es：海量数据搜索、分析、计算；

两者是互补，而非替代的关系。

## mapping索引操作

mapping类似于mysql里面的schema，是对于字段的约束；

mapping要考虑的问题：字段名、数据类型、是否参与搜索、是否分词、如果分词则分词器是什么？

**1.索引常见属性**

​![image](image-20240218163712-mit7gsh.png)​

注意：

* text类型是可以分词，keyword是不需要分词的内容；
* es里面没有数组这个概念，但是它可以允许一个key对应的多个值，也就是处处都可以是“数组”；

**2.索引增删改**

新增

```java
GET /索引库名
```

删除

```java
DELETE /索引库名
```

修改

es不允许修改索引库。

## 文档操作

**新增**

```java
POST /索引库/_doc/文档id
{
	“字段1”:"值1"
}
```

注意：文档id如果没有写，则es认为没有文档id，则会自动生成文档id；

**查询**

```java
GET /索引库/_doc/文档id
```

**删除**

```java
DELETE /索引库/_doc/文档id
```

**修改**

方式一：全量修改，这样会先根据id删除原文档，再新增。

```java
put /索引库/_doc/文档id
{
	"字段1"："值1"
}
```

注意：如果文档id不存在，则删除操作就无效了，但是新增操作还是存在的。所以如果文档id不存在，则改修改方式等同于新增。

方式2：局部修改，修改指定字段的值；

```java
POST /索引库/_update/文档id
{
	"字段1"："值2"
}
```

## 搜索

1.dsl查询分类

* 查询索引

  * match_all  
    ​![image](image-20240218173539-exxjjdm.png)​
* 全文检索：利用倒排索引查询；

  * match_query  
    ​​![image](image-20240218175139-gdqad33.png)​​![image](image-20240218174044-k8ryppy.png)​​
  * multi_match_query  
    ​​![image](image-20240218175201-ijdyx9d.png)​​![image](image-20240218174113-cuavm3n.png)​​
* 精确查询，根据精确词条查询，一般是keyword、数值、日期；精确查询要求所搜索的值与关键词完全相同才行。

  * range：范围  
    ​![image](image-20240218174958-w4oeqeq.png)​​![image](image-20240218175212-mlvma3z.png)  
    其中，gte是大于等于，lte是小于等于
  * term：词条精确值  
    ​![image](image-20240218174939-iq6m5ar.png)​​![image](image-20240218175245-pcsf8d4.png)​
* 地理查询

  * geo_distance：查询距离某个中心点小于某个具体值的所有文档  
    ​![image](image-20240218180408-m075iti.png)  
    以某个点为中心，半径15km画圆
  * geo_bounding_box：查询某个geo_point值落在某个矩形范围的所有文档  
    ​​![image](image-20240218180137-cb2cdkx.png)​​
* 复合查询，将上述各种条件组合起来，合并查询条件；  
  相关性算分：文档结果会根据与搜索词条的关联度打分，返回结果按照分值降序排序；  
  es的高版本中使用bm25  
  ​![image](image-20240218182252-di9y2zg.png)​

  bm25的优点在于受词频的影响有限：  
  ​![image](image-20240218182332-tmsdxlq.png)​

  * bool  
    复合查询，即与或非来组合这些条件；  
    ​![image](image-20240218183618-khmdnfw.png)​
  * function_score  
    三要素：

    * 过滤条件；
    * 算分函数；
    * 加权方式；

    ​![image](image-20240218182753-ngg866e.png)  
    给如家酒店加分：  
    ​![image](image-20240218183100-41vsbhz.png)​

* 搜索结果处理

  * 排序  
    默认根据相关性算分，如果指定了具体的排序字段，则es放弃算分。可以排序的字段类型有keyword类型、数值类型、地理坐标类型、日期类型等；  
    **示例：**   
    评分降序、价格升序搜索酒店：  
    ​![image](image-20240218184146-mhdswxf.png)  
    按照酒店距离我位置升序排序：  
    ​![image](image-20240218184333-l2xw0rj.png)​
  * 分页  
    es默认只返回top10的参数，如果要查询更多则需要修改分页参数；  
    可以通过修改from,size参数来控制返回的结果  
    ​![image](image-20240218184435-i8918lt.png)  
    es的排序如果需要查找900-1000范围的内容，则会搜索0-1000然后截取得到结果，这相当的消耗内存，所以es限制分页查询最大为1w条；  
    ​![image](image-20240218184815-j97vmbb.png)​
  * 高亮  
    服务端提前给搜索结果关键词加上标签，然后由前端控制样式即可。  
    ​![image](image-20240218185245-9wz5p7z.png)​

‍
