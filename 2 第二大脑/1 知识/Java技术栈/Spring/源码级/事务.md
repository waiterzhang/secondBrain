原理

```javascript
class UserServiceProxy extends UserService {
	UserService target;
	public void test(){
		//Before开启事务：
		// 1、 事务管理器新建一个数据库连接conn。这个conn将会放到TreadLocal<Map<DataSource, conn>>  
		// 2、conn.autocommit = false;

		target.test(
			// 拿到conn的连接来执行sql
		);

		// After
		// 如果没有异常，那就commit，如果出现异常那就rollback

	}
} 
```

Q：为什么事务管理器要建立一个连接，jdbc本身不是也会建立一个连接吗？  
A：jdbc建立的连接，sql执行完会直接提交，在方法层面很难回滚：

```javascript

class UserServiceProxy extends UserService {
	UserService target;

	@Transaction
	public void test(){
		jdbc.execute("sql1");
		jdbc.execute("sql2");
		jdbc.execute("sql3");
		throw new NPE;
	}
}

sql1已经提交了，该如何回滚呢？
```

事务失效

test和a方法都使用事务注解，但是test方法再调用a方法，那么a方法的事务会生效吗？

```javascript
class UserServiceProxy extends UserService {
	UserService target;

	@Transaction
	public void test(){
		jdbc.execute("sql1");
		a();
	}

	@Transaction()
	public void a(){
		jdbc.execute("sql2");
	}
}
```

不会生效。

原因在于调用test的时候用的是代理对象的调用的test，代理对象里面增强了这段代码，处理了事务注解从而实现了事务。代理对象test中的在调用普通对象test的时候就没有增强逻辑了。所以在执行a方法的时候压根没有人来处理a方法头顶的注解方法，因此注解也就不会起作用。

这是叫类内调吗？

该如何解决呢？

- 拆类，让代理对象能够感知到方法即可。
    
    ```javascript
    class  UserService {
    	@Autowired
    	private jdbc;
    	// 新增一个类，让他注入进来。
    	@Autowired
    	private userServiceBase;
    
    	@Transaction
    	public void test(){
    		jdbc.execute("sql1");
    		// 把这个类给拆出来调用。
    		userServiceBase.a();
    	}
    }
    ```
    

- 自己注入自己 ：
    
    ```javascript
    class UserService {
    	@Autowired
    	private jdbc;
    	// 自己注入自己
    	// 注意，被注入进来的是一个代理对象，只有代理对象才能有“增强”的功能
    	@Autowired
    	private userService;
    
    	@Transaction
    	public void test(){
    		jdbc.execute("sql1");
    		// 把这个类给拆出来调用。
    		userService.a();
    	}
    }
    ```
    

Configuration的原理

为什么AppConfig加上@Configuration才能使事务生效呢？

- 上面说了，事务生效的关键逻辑在于事务管理器和jdbc用的数据源是同一个，且事务管理器会关闭非自动提交。
- 问题的关键在于如何让事务管理器和jdbc拿到同一个数据源呢？
- 实际上AppConfig加上@Configuration也会生成一个代理对象，这个代理对象在事务管理器和jdbc拿dataSource的时候会先看一下对应的dataSource是否存在，如何存在就用已经存在的，再new一个出来。  
    所以获取数据源的dataSource方法在执行的时候都是代理对象的dataSource在执行。