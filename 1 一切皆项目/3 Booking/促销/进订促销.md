# 进订促销

### 促销结构转booking内部结构`PromotionInfoProcessItem`​

* 数据来源：`orderPriceData.QOrderPriceSection.orderBenefits`​​，将其绑定到`PromotionBookingParameter.benefits`​​这个字段上
* 将促销数据结构转换为booking内部结构，处理对象：`PromotionBookingParameter.benefits`​​

  * 判断是否是权益，判断依据：`benefits.benefitPattern=6或者7`​​

    * 如果是权益，则进行权益转换。 **（权益云内容待补充）**​`transmitServiceRight`​​
    * 如果不是权益

      * 字段转换，起点`QOrderBenefit`​​、`QOrderProduct`​​，终点：​`BizPromotionInfo`​​

        * 其中包括公有字段：二级活动标志`promotionCode`​、优惠币种`currencyCode`​、使用时机`whenToUse`​（下单/支付）、是否默选、优惠规则`promotionRule`​、权益类型`benefitPattern`​等等直接拷贝过来的内容。还有一些非直接拷贝的。

          * 优惠类型，确定promotionType：

            * 非金额类优惠，判断依据：`benefitPattern`​​=2（订单非金额类）、4（间夜非金额类优惠）、7（费金额类权益云），将其`promotionType`​​填充为`TICKET`​​。
            * 订单权益类优惠，判断依据`benefitPattern`​​=5，将其`promotionType`​​填充为`ORDER_BENEFIT`​​；
            * 否则，将其`promotionType`​​填充为优惠本身名称`QOrderBenefit.type.name`​​
          * 转换使用条件，确定`benefitCondition`​​：`QOrderBenefit.promotionCondition.moneyConditions`​​转为`PromotionCondition`​​：

            * ​`orderAmount`​​，订单金额比较的基准值。满足该值，享受某个优惠。  
              ​![image](image-20240116145804-u2frbth.png)  
              这是在做什么？
            * ​`favorAmount`​​，满足基准值之后享受的优惠金额。
            * ​`usePoints`​​：需要的积分。
            * ​`dailyFavorAmounts`​​：每日优惠。一个样例：

              ```java
              "dailyFavorAmounts": [
                  {
                      "date": "2024-02-16",
                      "favorAmount": {
                          "amount": 420,
                          "currency": "CNY"
                      },
                      "bonusPoint": 0
                  }
              ]
              ```
          * 可退的代金券（`订单取消需要退款用户的代金券`​​）：

            * ​`QOrderBenefit.refundable && QOrderBenefit.voucherBenefit都为true`​​
          * 父级活动id`parentActivityId`​​：`QOrderBenefit.benefitTracing.benefitTrackingParameters.get(parentActivityId)`​​
          * **其中还包括一些权益云的信息（都非权益了，咋还转换权益云的信息？）**
        * 适配非促销系统优惠专属字段

          * 非促销系统优惠判断依据。`QOrderBenefit.promotionCode`​以'X_'开头
          * 适配的内容：将`BizPromotionInfo`​的`promotionCode`​、`promotionName`​、`secondaryPromotionTitle`​、`promotionDesc`​、`promotionType`​、`shortTips`​、`optionText`​字段都从配置中拿。
      * 将字段组合，目标`PromotionInfo`​。`PromotionInfo`​其中包括字段`List<BizPromotionInfo>`​：

        * ​`categoryId`​，一级活动分类唯一标识，例如：使用红包。
        * ​`useTitle`​，优惠标题
        * ​`source`​，优惠来源：平台优惠、商家优惠等
        * 等等
      * 对非特殊优惠进行过滤。特殊优惠的判断依据：当前为`benefitPattern`​=8，或者promotionCode =FLIGHT_HOTEL_FREE_REFUND,FLIGHT_HOTEL_BUY_EXPENSIVE,FLIGHT_HOTEL_CASH_BACK，可配置。

        * ​`立减优惠`​且优惠金额小于0会被移除。（此处表达极不准确，自行参考`PromotionBookingHelper.filter`​方法）
  * 组装数据，目标​`PromotionBookingResult`​

    * 这里组装的数据，都是上面已经转换好的数据。
    * ​`spcialPromotionList`​和`promotionInfoList`​的结构基本相同，但是后者过滤，前者不过滤。

### 计算多间价格

* 计算的来源：`promotionBookingResult.promotionInfoList.allPromotionInfos`​，计算的目标`promotionBookingResult.promotionInfoList.allPromotionInfos.amountRoomNights`​
* 先看是否需要计算多间价格。判断依据：订单金额类`benefitPattern`​ = 1、金额类权益云`benefitPattern`​ = 6、订单非金额类优惠 = 2、非金额类权益云 = 7【一共有哪些种类？这些种类有什么区别？】
* 使用规则`BizPromotionInfo.benefitCondition`​根据订单比较基准值进行从大到小排序；之所以从大到小排序是因为适配的时候要找到最“合适”的一个。
* 构建券/优惠：

  * 非金额类，则构建券​`RoomTicket`​，其中包括四个字段：

    * ​`roomNum`​：房间数量
    * ​`count`​：券数量，固定写死为1；
    * ​`券单价`​：券单价
    * ​`totalAmount`​：总金额
  * 金额类，构建​`RoomAmount`​：

    * 获取最匹配的（可用优惠中金额最大的）规则；
    * 如果使用规则`BizPromotionInfo.benefitCondition`​不为空：

      * 如果一个都没匹配上，则优惠金额为0，每日优惠为空。
      * 如果匹配上：

        * 可享受的优惠金额=`PromotionCondition.favorAmount.amount`​
        * 每日优惠金额= `PromotionCondition.dailyFavorAmounts`​
        * 使用积分 = `PromotionCondition.usePoints`​
    * 如果规则`BizPromotionInfo.benefitCondition`​为空：

      * 则计算每晚优惠 = （每晚优惠 除以 入住房间数量） 向上取整， 乘以 所定间数
      * 计算每间夜佣减`qOrderProduct.product.dailyPrices.detail.newCommissionSubtractPrice`​ + 超减`detail.excessSubtractPrice`​ **【啥叫佣减、超减？】**
      * 每日优惠金额 = 每晚间夜佣减 * 间数
    * 更新roomAmout： **【看的不是很明白】**

      * 疑似在计算发放的积分数量；
      * 优惠金额等字段赋值。
* 将券/优惠设置到对应的字段，目标`BizPromotionInfo`​

### 优惠出参转换​`buildDiscount`​

* 结构转换，转换目标：`Discount`​​

  * 获取身份列表，优惠处理需要用到。
  * 过滤身份列表，目前只包括新版机酒身份、火酒身份；
  * 数据赋值，包括直接拷贝的内容：

    * ​`categoryId`​​，活动分类
    * ​`source`​​，来源，平台促/商促
    * ​`preferText`​​ = ​`useTitle`​​，优惠类型
    * ​`name`​​ = `promotion_offer`​​ + ​`categoryId`​​
    * ​`type`​​取优惠类型第一个的promotionType
    * ​`preferWay（优惠形式：离店再返(cashback)、已减(cut)、赠送(additional)）`​​ =​`discountType`​​

      等等
  * 数据赋值，非直接拷贝的内容：

    * ​`**代金券处理buildSequence**`​**没看懂**
    * 设置非促销系统的优惠。前面有促销系统的优惠，也有非促销系统的优惠，对于返回给前端的内容都统一使用discount来表示，不再区分是否特殊。
    * 转换option，目标Disount.options：

      * 处理展示文案，如果`BizPromotionInfo.displayText`​​包括指定的key（常量），则将`BizPromotionInfo.displayText`​​对应的key放到`BizPromotionInfo.promotionName`​​
      * 处理金额类`benefitPattern`​​ = 1、3、6

        * 从`BizPromotionInfo`​​中直接拷贝额外参数到`DiscountOption.extra`​​
        * 处理多间价格，来源`BizPromotionInfo.amountRoomNights（这个之前计算过）`​​，目标`DiscountOption.roomNumMappings`​​

          * ​`points`​​,使用的积分数
          * ​`maxMoney`​​，优惠的最高金额
          * 如果是学生优惠，`price`​​ = ​`roomAmount.getMaxAmount()`​​
          * 如果非学生优惠（存疑） 且 金额不为空 且 金额大于0，​`price`​​ = `roomAmount.getAmount()`​​
          * 处理每日优惠，计算日期（`dailyFavorAmount.getDate()`​​）、价格`dailyFavorAmount.getFavorAmount()`​​，如果价格为空，则置为0；
          * 计算方式：百分比/定额
          * 设置优先级​`priority`​​

          等
      * 处理非金额类

        * 设置扩展参数`DiscountOption.extra`​​
        * 设置`roomNumMappings`​​，这个处理的对象主要是`BizPromotionInfo.ticketRoomNights`​​
        * 构建非金额类详情文案
        * 设置非金额类单位：张

‍

### 几个优惠结构的关系

​`QOrderBenefit`​列表循环按照出资方分组，组别使用`CategoryId`​表示，`QOrderBenefit`​本身对应一个活动，`QOrderBenefit`​转化为`BizPromotionInfo`​。

也就是说一个`PromotionInfo`​代表一个分组，`PromotionInfo`​中每个`BizPromotionInfo`​代表一个活动。

‍

​`BizPromotionInfo`​会被转换成`DiscountOption`​，一组`BizPromotionInfo`​被转换到一组`DiscountOption`​，一个`Discount`​包含一组`DiscountOption`​。实际上一个`Discount`​对应一个`PromotionInfo`​。一个`QOrderBenefit`​对应一个`DiscountOption`​。

‍

‍
