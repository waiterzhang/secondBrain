# 进订报价查询与处理

* 构建查询报价的参数。（人、 房、前置控制参数、报价刷新依赖字段等）

  * 酒店相关：`supplierId`​、`wrapperId`​、`hotelSeq、storeCoupon`​等，这些内容来自于`request.getProduct`​
  * 入住相关：入离日期、到达时间、房间数等，这些内容来自于`BookingContextParam`​
  * 用户相关：userid、username，这些内容来自于c参；会员身份
  * 前置控制：d页报价id、fast报价id、强制刷新标识（标识不为空则给报价传实时报价标识）、设置入住即享token
  * rulecode构建，venus 传过来的ruleCode 升级列表，主要用于torch升级报价：

    * 请求报价传递辅营商品对应的券、场景、ruleCode

      > 看起来只是刷新报价所用到的商品code
      >
  * 其它：版本、投毒等
  * 以上内容只是总览，并不全面。
* 构建促销的查询参数`SectionsQuery`​

  * 入离日期、c参、系统级公共参数、
* 查询进订的order报价、打印查询参数及返回结果的日志。
* 报价后处理。（进订请求报价后，对报价数据做改动）

  * 如果是该单，且原单不可取消，改单也不可取消。判断依据：`tringUtils.isNotBlank(request.getProduct().getModifyOrderNo())`​。

    * 判断是否规则外取消？

      * 全预付，取消规则在`orderProduct.getPrice().getRefundRule()`​，
      * 非全预付（担保等），取消规则在`orderProduct.getPrice().getGuaranteeRule();`​
    * 如果不可取消：

      * 全预付：以下三个地方均展示**不可取消变更**

        * ​`QOrderProduct.getPrice().setRefundRule`​
        * ​`QOrderProduct.getProduct().getRatePlan().setRefundRule`​
        * ​`QOrderProduct.getPrice().getqOriginalOrderPrice().setRefundRule`​
      * 非全预付：在以下这些地方展示**不可取消变更**

        * ​`QOrderProduct.getPrice().getGuaranteeRule().setCancelRule`​
        * ​`QOrderProduct.getPrice().getqOriginalOrderPrice().setCancelRule`
        * ​​`QOrderProduct.getPrice().getqOriginalOrderPrice().setRefundRule`​
        * ​`QOrderProduct.getProduct().getRatePlan().getGuaranteeRules().setCancelRule`​（有判断条件）
  * 机酒交叉权益做版控，旧版rn不展示和享受该权益；预售券预约的酒店不享受机酒交叉权益。处理方式：删除掉对应的权益。
  * 过滤酒套套餐，过滤条件：

    * 非app不过滤；
    * 酒套2、3、5类型不过滤；
    * 其他酒套内容均删除。
* ~~象币（已废弃）~~
* ~~删除无效权益，鱼池业务相关。（已废弃）~~
* 可定校验

  * ​`qOrderProduct.getPrice().getBookingCode != QBookingCode.ok`​
  * ​`校验入住日期是否早于目的地城市的当前日期`​

‍

‍
