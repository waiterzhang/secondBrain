# 信用住包装

**总结一下：**

* 想用先住后付，首先得是报价支持先住后付
* 报价共有三种信用类型，booking将两种预付的信用类型（信用住、先住后付），包装成后付（trade auth）信用类型。
* 在此基础上，会对先住后付在一些校验和过滤：

  * 程信分校验
  * 开关配置
  * 支付宝、微信绑定关系
  * 是否是支付宝、微信绑定新用户
* 如果出先住后付，则`flashLodging`​字段会有值，booking会对其中的文案、条款做填充。

‍

**具体细节：**

* 一些情况屏蔽先住后付：

  * 有微信政府券
  * 辅营服务包（B页如果选了辅营，会直接切换为在线付）

* 校验D页给的信用类型与B页是否一致；

  * ​`getRequest().getProduct().getExtMap`​的`creditType`​，这个是D页透传的报价相关参数
  * 进订报价拿的信用类型`qOrderProduct).map(QOrderProduct::getProduct).map(QProduct::getOrderCreditType`​
* 构造先住后付数据：

  * 风控校验不通过，不走先住后付；
  * 报价信用类型过滤：报价里面有三种信用类型（先住后付、信用住、信用担保），而信用住是一种预付，所以要把现付给过滤掉。
  * 针对端+信用类型进行开关控制。如果满足要求，则授权类型为`trade_auth`​，这是新的后付授权。即：报价里面的`flash_credit`​闪住、`pay_later`​先住后付，都会在booking这里被包装成一个新的先住后付`trade_auth`​授权类型。
  * 根据不同报价授权类（闪住、先住后付）型写入不同的标题、协议内容。从前端视角来看，两种报价信用类型几乎没有区别。
  * 老后付，不知道是什么，已经下线了。
* 先住后付，后处理

  * 如果在实验中 && 全日房 && 非预约 && 后付 && 信用住验证非失败：出信用住且默勾
  * 查不到支付宝、微信绑定关系，不出先住后付。
  * 后付中，支付宝、微信绑定关系中如果是新用户 && 信用住校验为需要查第三方，则默勾在线付（有开关）
  * 后付中，支付宝、微信绑定关系如果是新用户 && 信用住验证为true，则默勾在线付。
  * 其他情况均走先住后付
* 如果有先住后付，B页会给相关协议；

‍

‍
