# 支付完成页

### 查询订单数据

* 根据订单号向交易查询订单数据，如果查不到则直接中断流程。

### 权限校验（用户登录状态以及订单归属）

* 权限校验有开关，当前为开；
* 如果订单数据为空，则认为通过校验；
* 联系人手机号（手机号需要加解密）相同（本次请求的携带的手机号vs订单中的手机号）相同则认为校验通过（有开关，当前为开）；
* 如果未登录，则校验不通过，流程中断；
* 校验订单归属（本次请求vs 订单中username、userid），两者有任一不一致，则认为校验失败，流程终止。

## 引导关注微信公众号

* 有开关，当前为开；
* 该活动apollo内部只出前端样式；

## ~~关注公众号返现~~

* 有开关，当前为开；
* 查询Apollo，当前活动在apollo已下线；

### 砍单活动

* 有开关，当前为关；
* 有版控，bizVersion大于等于227；
* 订单状态只有在以下状态时才展示：

  * 待提交；
  * 成单；
  * 确认中；
  * 确认单；
  * 已离店；
* 查看订单是否有砍单优惠，如果没有砍单优惠则不展示；
* 请求Apollo创建完成页的砍单活动；

### 查询酒店UGC评分

* 从订单数据中获取hotelSeq，如果hotelSeq为空，则酒店ugc评分为空；
* 根据seq查询评分：`http://reviewcn.corp.qunar.com/api/h/proc/hotel/score`​，调用该接口只会读取酒店评分。ugc内部同样只读，不会改变ugc内部的状态。

### ~~查询砍单活动信息~~

* apollo内部该活动已下线；

* 有开关，当前为开。
* 判断订单中是否有任务券；判断路径`orderData.getMainOrder`​-`getOrderProduct`​-`getOrderProductBase`​-`getPromoteInfo`​-`getActivityBenefitInfos`​-`getCategoryId`​ = `2013`​，如果没有任务券，则无砍单活动。
* 查询砍单活动，url = [ttp://supercell.corp.qunar.com/bargain/entrance](ttp://supercell.corp.qunar.com/bargain/entrance "下列链接") packageCode = hotel_bargain_2020 activityCode = hotel_bargain_forward；
* 转换砍单活动数据

  * 校验返回数据有效性（通过状态码）
  * 非透传数据：

    * 计算还需邀请几人：任务目标人数  - 当前助力人数；
    * 任务倒计时：当前时间与任务截止时间的差距；
  * 转换其他透传数据；

### 查询特牌补贴抽奖

* 有开关，当前为开。
* 有版控，bizversion>286;
* 创建特牌补贴抽奖活动：

  * frompage = `hotel_lucky_draw`​
  * 有过滤器；
  * 创建活动会调用酒店相关系统（促销？）发券；

### ~~拼团活动~~

* 该活动在apollo已下线；

* 有开关，当前为开
* 如果订单创建日期为空，则不创建拼团活动；
* 如果当前时间距离下单时间已经超过1h，则不创建拼团活动；
* 非拼团报价不创建拼团活动；
* 构造数据，请求拼团；

  * formpage = `hotel_join_group_pop`​

### 查询neeko数据

* 有开关，当前状态为开；
* 构建参数，会把一下活动都放到查询参数中

  * 拼团活动信息；
  * 微信引导关注活动；
  * 微信关注返现活动；
  * 拼团活动；
  * 特牌抽奖活动；
  * 砍单活动；
* 查询popupInfo、tipNeekoInfo，两者的区别在于不同的前端组件；对于neeko查询到的数据为透传；

### 查询Saturn

* 有开关，当前为开；
* 查询酒店基础的raw信息，url=`http://saturn.corp.qunar.com/hotel/tag`​
* 取`Opt.of(data).map(m -> m.get("rawAttrs")).map(raw -> raw.get(hotelSeq)`​
* 查询saturn只有读信息，不会改变saturn的内部状态；

### 查询交叉引流售卖

* 有开关，当前为开；
* 仅限app端；
* 查询url = `http://bigcross.corp.qunar.com/cross/api/crossCard`​
* 该活动为公共团队负责，调用该接口只读，不会改变公共团队系统内部状态；

‍

### 数据汇总处理

* 根据报价数据，构造餐食信息；

* 根据权益云信息，构造权益云餐食信息；
* 设置分享信息（该处分享逻辑与O页相同）：

  * 有开关，当前开关为true；
  * 小时房不处理；
  * 酒店基础信息（酒店名称、一句话描述、入离日期、房间信息等等）；  
    其中`外露信息是否使用saturn服务数据`​有开关，当前状态为开。如果为关，则房间信息来自于报价；
  * 餐食信息处理：如果报价中包含餐食，则展示为“有餐食”，如果报价中没有餐食，则查看权益中是否有餐食；
  * 新版分享浮层可配置，可配置内容为：`分享酒店标题,分享行程按钮标题,分享订单按钮标题`​、`离店前标题,离店后标题`​
  * 设置截屏分享按钮展示，不配置则不展示；
* 设置酒店信息：

  * 酒店名称、seq、城市、城市id、百度坐标；
* 设置订单信息：

  * 订单号、入离日期；
* 设置完成页订单状态：

  * 现付担保订单：

    * 支付状态：`等待酒店确认`​
    * tip：：酒店确认结果中，请及时关注消息通知
    * iconTip：因酒店库存、价格变动等原因，在您支付成功后尚需等待商家确认订单，确认成功后订单生效；不成功则订单自动取消。
  * 非现付担保订单：

    * 支付状态：支付成功
* 透传neeko信息
* 透传交叉引流售卖信息；
