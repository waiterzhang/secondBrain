# 全局异常处理器（一）

> Q1：如何控制跳转？
>
> 使用Pageto来控制。
>
> Q2：如何控制给前端的文案，异常的Mesage什么时候客户会看到，什么时候看不到？
>
> 与文案相关的字段一共有三个：des、errSys、errMtns.prompt
>
> * des、errMtns.prompt两个都是对客文案，看起来一样，应该是版本兼容问题，导致有了两个字段。
>
> * errSys是指系统内直接放message里面信息，一般来讲是不会直接投给客户的，但是对于某些类型（UserPromptEx）的异常，这个也可以作为对客文案。同时errSys，在下单环节也会作为Map里面的Key来去读取配置中的错误配置信息。

​`BookingExceptionResolver`​针对非`/hb/api/`​下面的所有接口。

1、异常监控

* 对异常进行统一监控

2、确定code、errSys等

* 根据异常类型确定code和errSys，code主要是用来辨别某一个异常等处理方式和文案，errSys看起来像一个文案。如果没有匹配上特定的code和errSys，就会使用兜底的code=999，以及errSys=message（填充的文案）来确定。

3、根据前缀来确定是否需要进行特殊处理：

* 如果errSys里面包含字符串：`Waiting server-side response timeout`​，便会将原市的errSys替换成`dubbo time out`​超时相关文案。（看起来更易懂、更统一）。

4、文案裁切

* 如果errSys过长（超过190），则会进行裁切。

5、读取配置，指定行为。

* 首先根据接口确定属于配置的哪一部分（配置整体可以看作一个Map）。
* 根据code拿到对应的配置项；如果是submit接口，使用`errSys`​当作key去拿值。可以看到，既有数字型code也有字符串作为key：  
  ​![image](image-20240612172150-i2vwnr5.png)​
* 如果拿到了配置的error，就会使用配置型填充：

  * msg、promot。这个是用户能看到的提示项。
  * pageto：代表跳转页面。目前常见23/24，50，基本上就是跳转D页还是当前页面（不确定）。
  * resets：用于清空填单页内容。目前只有2、7，大概代表清空入住人信息or清空手机号（不确定）。
* 如果读取不到配置，或者读取的配置中不包含对客文案（prompt），则：

  * 该异常如果是`UserPromptException`​，则code、msg、prompt都从异常中直接拿。
  * 兜底使用默认文案以及状态码：`服务器累了，请稍后重试`​

6、针对特定的版本，返回code和跳转pageto（看起来是很老的版本了，目前感觉不用关注）

7、 处理特定接口

* 刷新接口 且 `ServiceException`​（多间商促）异常：监控失败量
* 进订强制刷新 且 有`availableQuantity`​（这是一个来自于报价可用间数相关的字段）：将进订出参结果重置（添加`availableQuantity`​字段），前端需要使用这个字段。  
  为啥会给进订出参？
* 下单接口 并且是 orderException：为啥都会给的新的submitResult

  > 之所以没有给Reulst，而是给了SubmitResult，是因为想带更多的字段回去。而Result里面不宜增加过多的字段。
  >
  > 为啥会给进订出参，原理同上。
  >

  * 授权类报价标识变化导致下单失败，重置结果跳转D页
  * 先住后付 & 闪住失败处理
  * 重复单处理
  * 风控拦截处理
* 处理`touchPrePay`​接口

8、取消失败原因记录：记录一下订单号以及错误提示信息

9、错误原因再分类。根据配置再次填充errType和errTypeName字段：  
​![image](image-20240612174832-0hkbmwy.png)​

如果errSys里面包含上面Map中的值，则会进行具体的记录。根据配置进行分类。不在map中的会走默认。

10、把result的值，写到resp里面去。写的过程中，将Value包装一下。

11、监控返回值的状态。

12、进订+下单，失败消息发送。

‍
