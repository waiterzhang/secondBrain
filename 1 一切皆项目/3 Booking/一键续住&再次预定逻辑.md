# 一键续住&再次预定逻辑

## 再次预定

* 已离店&已取消&支付超时&noshow均不做处理
* 预定失败：

  * 预售订单不支持再次预定；
  * 当前时间早于入住人，D页搜索原单入离日期；当前时间晚于原单入住时间，则D页搜索，入著时间 = 当前时间，离店时间 = 当前时间+1；
* 构建schema：【5004、4519、4513、5005这几个来源均使用此方法】

  * cityUrl
  * fromForLog【来源】
  * hotelSeq
  * fromDate
  * toDate

## 续住

‍

‍

## 餐食计算

> 可选餐食类型为一个数组
>
> 可选餐食类型为一个整数值，意味着选任何类型的餐食都不影响餐食的数量。

先将报价里面的餐食转化为booking内部模型

**固定餐食**（可选餐食类型 = 0 & 可选餐食数量 = 0）

* 如果**今天**早、午、晚有任一包含餐食：

  * 将今天的晚餐放到今天的晚餐中；
  * 将**今天**的早餐、午餐放到**明天**要显示的内容中去。
* 全量构建第一天的标题；

  * 早餐+午餐+晚餐；

> 之所以早餐午餐vs晚餐分开计算，原因在于报价给的数据里面的早餐指的是该间夜跟随的早餐，并不是当天时间的早餐，一般入住日期要在中午以后，当天的早餐时间都过去了。所以实际的早餐时间是第二天的早上，午餐同理。
>
> title构建不分这些内容，全量展示。

**可选餐食（3选1、3选2）**

* 从早餐、午餐、午餐中选一种，每一种有对应的份数。

**可选餐食（2选1）**

* 固定1份+二选1
* 只有二选1

‍

‍

‍

‍

## 权益云处理餐食

权益云只有早餐

DailyAmount为每日数量

```java
        int totalNum = Opt.of(benefitInfo.getDailyAmount())
                .mapToInt(das ->
                        das.stream()
                                .mapToInt(ActivityBenefitInfo.DailyAmount::getAmount)
                                .sum()
                ).orElse(0);
        if (totalNum == 0) {
            return null;
        }
```

## 餐食信息转换

* ​`dailyPrices`​和`originalDailyPrices`​的区别是什么？
* 为啥早餐午餐 vs 晚餐要分开算？

‍
